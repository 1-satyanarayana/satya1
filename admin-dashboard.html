<!DOCTYPE html>
<html>
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        table, th, td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 6px;
        }
    </style>
</head>
<body>

<!-- ---------------- Admin Header ---------------- -->
<h2>Welcome, <span id="adminNameDisplay"></span></h2>
<button onclick="logoutAdmin()">Logout</button>
<hr>

<!-- ---------------- Add Student ---------------- -->
<h3>Add Student</h3>
<input id="stuName" placeholder="Name"><br><br>
<input id="stuRoll" placeholder="Roll Number"><br><br>
<input id="stuLoginId" placeholder="Login ID"><br><br>
<input id="stuPassword" placeholder="Password"><br><br>
<button onclick="addStudent()">Add Student</button>
<p id="stuMsg"></p>

<h4>Upload Students (Excel)</h4>
<input type="file" id="stuExcelFile" accept=".xlsx,.xls">
<button onclick="uploadStudentExcel()">Upload Excel</button>

<h4>Student List</h4>
<table>
<tr>
    <th>Name</th>
    <th>Roll</th>
    <th>Login ID</th>
    <th>Password</th>
    <th>Edit</th>
    <th>Delete</th>
</tr>
<tbody id="studentTable"></tbody>
</table>
<hr>

<!-- ---------------- Add Question ---------------- -->
<h3>Add Question</h3>
<textarea id="qText" placeholder="Question" rows="3" cols="60"></textarea><br><br>
<input id="qO1" placeholder="Option 1"><br><br>
<input id="qO2" placeholder="Option 2"><br><br>
<input id="qO3" placeholder="Option 3"><br><br>
<input id="qO4" placeholder="Option 4"><br><br>
<input id="qCorrect" placeholder="Correct Option (1-4)"><br><br>
<button onclick="addQuestion()">Add Question</button>
<p id="qMsg"></p>

<h4>Upload Questions (Excel)</h4>
<input type="file" id="qExcelFile" accept=".xlsx,.xls">
<button onclick="uploadQuestionExcel()">Upload Excel</button>

<h4>Questions List</h4>
<table>
<tr>
    <th>Question</th>
    <th>Option 1</th>
    <th>Option 2</th>
    <th>Option 3</th>
    <th>Option 4</th>
    <th>Correct</th>
    <th>Edit</th>
    <th>Delete</th>
</tr>
<tbody id="questionTable"></tbody>
</table>

<script type="module">
    // ---------------- Firebase ----------------
    import { db, auth } from "./firebase.js";
    import { collection, doc, setDoc, addDoc, getDocs, deleteDoc, updateDoc } 
        from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // ---------------- Admin Auth Protection ----------------
    const adminName = localStorage.getItem("adminName");
    const adminEmail = localStorage.getItem("adminEmail");

    if (!adminName || !adminEmail) {
        alert("Please login as admin to access this page!");
        window.location.href = "login.html";
    }

    document.getElementById("adminNameDisplay").innerText = adminName;

    function logoutAdmin() {
        localStorage.removeItem("adminName");
        localStorage.removeItem("adminEmail");
        window.location.href = "login.html";
    }

    // ---------------- Add Student ----------------
    window.addStudent = async function () {
        const name = document.getElementById("stuName").value;
        const roll = document.getElementById("stuRoll").value;
        const loginId = document.getElementById("stuLoginId").value;
        const password = document.getElementById("stuPassword").value;

        await setDoc(doc(db, "users", loginId), {
            name, roll, loginId, password, role: "student"
        });

        document.getElementById("stuMsg").innerText = "Student Added!";
        loadStudents();
    }

    // Load Students Table
    async function loadStudents() {
        const studentTable = document.getElementById("studentTable");
        studentTable.innerHTML = "";
        const snap = await getDocs(collection(db, "users"));
        snap.forEach(docu => {
            const s = docu.data();
            if (s.role === "student") {
                studentTable.innerHTML += `
                    <tr>
                        <td>${s.name}</td>
                        <td>${s.roll}</td>
                        <td>${s.loginId}</td>
                        <td>${s.password}</td>
                        <td><button onclick="editStudent('${s.loginId}')">Edit</button></td>
                        <td><button onclick="deleteStudent('${s.loginId}')">Delete</button></td>
                    </tr>
                `;
            }
        });
    }
    loadStudents();

    window.deleteStudent = async function (id) {
        await deleteDoc(doc(db, "users", id));
        loadStudents();
    }

    window.editStudent = async function (id) {
        const newName = prompt("Enter new name:");
        const newRoll = prompt("Enter new roll number:");
        const newPass = prompt("Enter new password:");
        await updateDoc(doc(db, "users", id), {
            name: newName,
            roll: newRoll,
            password: newPass
        });
        loadStudents();
    }

    // Excel Upload for Students
    window.uploadStudentExcel = async function () {
        const file = document.getElementById("stuExcelFile").files[0];
        if (!file) return alert("Select Excel file!");
        const reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = async (e) => {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: "binary" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelData = XLSX.utils.sheet_to_json(sheet);
            for (let x of excelData) {
                await setDoc(doc(db, "users", x.LoginId), {
                    name: x.Name,
                    roll: x.Roll,
                    loginId: x.LoginId,
                    password: x.Password,
                    role: "student"
                });
            }
            alert("Students uploaded!");
            loadStudents();
        }
    }

    // ---------------- Add Question ----------------
    window.addQuestion = async function () {
        const q = document.getElementById("qText").value;
        const o1 = document.getElementById("qO1").value;
        const o2 = document.getElementById("qO2").value;
        const o3 = document.getElementById("qO3").value;
        const o4 = document.getElementById("qO4").value;
        const correct = Number(document.getElementById("qCorrect").value);

        await addDoc(collection(db, "questions"), {
            question: q,
            options: [o1, o2, o3, o4],
            correct
        });

        document.getElementById("qMsg").innerText = "Question Added!";
        loadQuestions();
    }

    // Load Questions Table
    async function loadQuestions() {
        const questionTable = document.getElementById("questionTable");
        questionTable.innerHTML = "";
        const snap = await getDocs(collection(db, "questions"));
        snap.forEach(docu => {
            const q = docu.data();
            questionTable.innerHTML += `
                <tr>
                    <td>${q.question}</td>
                    <td>${q.options[0]}</td>
                    <td>${q.options[1]}</td>
                    <td>${q.options[2]}</td>
                    <td>${q.options[3]}</td>
                    <td>${q.correct}</td>
                    <td><button onclick="editQuestion('${docu.id}')">Edit</button></td>
                    <td><button onclick="deleteQuestion('${docu.id}')">Delete</button></td>
                </tr>
            `;
        });
    }
    loadQuestions();

    window.deleteQuestion = async function (id) {
        await deleteDoc(doc(db, "questions", id));
        loadQuestions();
    }

    window.editQuestion = async function (id) {
        const newQ = prompt("Enter new question:");
        const o1 = prompt("Option 1:");
        const o2 = prompt("Option 2:");
        const o3 = prompt("Option 3:");
        const o4 = prompt("Option 4:");
        const correct = prompt("Correct Option (1-4):");
        await updateDoc(doc(db, "questions", id), {
            question: newQ,
            options: [o1, o2, o3, o4],
            correct: Number(correct)
        });
        loadQuestions();
    }

    // Excel Upload for Questions
    window.uploadQuestionExcel = async function () {
        const file = document.getElementById("qExcelFile").files[0];
        if (!file) return alert("Select Excel file!");
        const reader = new FileReader();
        reader.readAsBinaryString(file);
        reader.onload = async (e) => {
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: "binary" });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const excelData = XLSX.utils.sheet_to_json(sheet);
            for (let x of excelData) {
                await addDoc(collection(db, "questions"), {
                    question: x.Question,
                    options: [x.Option1, x.Option2, x.Option3, x.Option4],
                    correct: Number(x.CorrectOption)
                });
            }
            alert("Questions uploaded!");
            loadQuestions();
        }
    }

</script>
</body>
</html>
